SELECT  *  FROM ( select patientid from (select patientid, SourceRxMedName, cast(daily_dose as numeric) as xx from (
  select patientid, ((DOSE * RXQUANTITY)/rxsupply_updated) as daily_dose, SourceRxMedName from (
    select patientid,SourceRxMedName,ORDERDATE as drugdate, REGEXP_SUBSTR(RXDOSEORDERED,'\\d*') as DOSE,
    RXQUANTITY,RXENDDATE,RXSTARTDATE,case when rxdayssupply is null then (RXENDDATE-RXSTARTDATE) end as rxsupply_updated, DATAREFRESHID
    from "DEID_PLATFORM"."GRATICULESOW3A"."VW_DEID_MEDORDERS")
    where SourceRxMedName ILIKE ANY ('%Betamethasone%','%BUDESONIDE%','%CORTISONE%','%DEFLAZACORT%','%HYDROCORTISONE%','%METHYLPREDNISOLONE%','%PREDNISOLONE%',
                                      '%PREDNISONE%','%TRIAMCINOLONE%') AND  rxsupply_updated != 0  AND rxsupply_updated is NOT NULL AND DOSE is NOT NULL 
  AND  RXQUANTITY is NOT NULL and DATAREFRESHID = 1) ) where xx >= 3 )
  
  
  (select masterpatientid, count (distinct eligible_population.patientid) as xx from (
    select inclusion_crit1.masterpatientid, inclusion_crit1.patientid,       inclusion_crit1.dataownerid from ( 
        select masterpatientid,patientid,dataownerid 
        from "DEID_PLATFORM"."GRATICULESOW3A"."VW_DEID_PATIENTS" 
        where dataownerid IN('137301f961d1fd77b33c529c9be609e52c35aca429583fc49b93ffb36487101a','1cbb8cafcbcfc22addedb1d9e2034afe0a29bb5b74f1f230dfd58e12322a3e11','5540c5b22e7435d6eb2a63e3a80b623d75eb34812013cb78575843f661f9bbc7','5fdd0ff9ae31f6c7ce6a195bd1a13b382143b8b6e70780fc18acf579dfc5e54b','6b952660a48d81f2da56f80a7a695446ea01ba3942c0ee6da3f38dafb5d60920','7804f6717b418811a9797e1805a921fb5b9582943c78e3924925d551c650a2a3','86d8165865fdd068bbb2b235990d6ea56c39fac4a5dc1cc53f65d6bc675e6363','a3bc2a45e2fb93d0ea261db098c16e6d8156fcbca543157de8deffbb156c8901','c48925c0b23c35d71a975a18c9478d371ad8c12b94b3e179bd1db880d48e56df','c877ef723bbc0de29171dcaa993fe3b86064bb0d0d7be4523bb0b71688ebbb72') and DATEDIFF(year,BIRTHDATE,DATE('2022-02-24')) >= 12 and DATAREFRESHID = 1) inclusion_crit1 

        INNER JOIN (select patientid,encounterdate 
                    from "DEID_PLATFORM"."GRATICULESOW3A"."VW_DEID_ENCOUNTERS" 
                    where DATAREFRESHID = 1) inclusion_crit2 
        on inclusion_crit1.patientid = inclusion_crit2.patientid 
        where (encounterdate >= ((DATE('2022-02-24'))-365) AND 
        encounterdate <          AND encounterdate is not null)) eligible_population 

INNER JOIN (Select patientid,dxdate from ( 
                SELECT patientid,pxdate as dxdate 
                FROM "DEID_PLATFORM"."GRATICULESOW3A"."VW_DEID_PROCEDURES" 
                where pxcode in ('0055U','0087U','0088U','0141T','0142T','0143T','0584T','0585T','0586T','23440','29868','32851','32852','32853','32854','33927','33929','33935','33945','38240','38241','38242','38243','43625','44135','44136','44137','47135','47136','48160','48554','48556','50340','50360','50365','50366','50370','50380','60510','60512','65710','65720','65725','65730','65740','65745','65750','65755','65756','65767','65780','65781','65782','76776','76778','81595','G0341','G0342','G0343','G8727','S2052','S2053','S2054','S2060','S2065','S2102','S2103','S2109','S2142','S2150','S2152','02Y','02YA','02YA0Z0','02YA0Z1','02YA0Z2','07Y','07YM','07YM0Z0','07YM0Z1','07YM0Z2','07YP','07YP0Z0','07YP0Z1','07YP0Z2','0BY','0BYC','0BYC0Z0','0BYC0Z1','0BYC0Z2','0BYD','0BYD0Z0','0BYD0Z1','0BYD0Z2','0BYF','0BYF0Z0','0BYF0Z1','0BYF0Z2','0BYG','0BYG0Z0','0BYG0Z1','0BYG0Z2','0BYH','0BYH0Z0','0BYH0Z1','0BYH0Z2','0BYJ','0BYJ0Z0','0BYJ0Z1','0BYJ0Z2','0BYK','0BYK0Z0','0BYK0Z1','0BYK0Z2','0BYL','0BYL0Z0','0BYL0Z1','0BYL0Z2','0BYM','0BYM0Z0','0BYM0Z1','0BYM0Z2','0DY','0DY5','0DY50Z0','0DY50Z1','0DY50Z2','0DY6','0DY60Z0','0DY60Z1','0DY60Z2','0DY8','0DY80Z0','0DY80Z1','0DY80Z2','0DYE','0DYE0Z0','0DYE0Z1','0DYE0Z2','0FY','0FY0','0FY00Z0','0FY00Z1','0FY00Z2','0FYG','0FYG0Z0','0FYG0Z1','0FYG0Z2','0TY','0TY0','0TY00Z0','0TY00Z1','0TY00Z2','0TY1','0TY10Z0','0TY10Z1','0TY10Z2','0UY','0UY0','0UY00Z0','0UY00Z1','0UY00Z2','0UY1','0UY10Z0','0UY10Z1','0UY10Z2','0UY9','0UY90Z0','0UY90Z1','0UY90Z2','0WY','0WY2','0WY20Z0','0WY20Z1','0XY','0XYJ','0XYJ0Z0','0XYJ0Z1','0XYK','0XYK0Z0','0XYK0Z1') and pxdate is not null and DATAREFRESHID = 1 

        UNION ALL 

                SELECT patientid,dxdate 
                FROM "DEID_PLATFORM"."GRATICULESOW3A"."VW_DEID_DIAGNOSES" 
                where dxcode in ('C80.2','I25.750','I25.751','I25.758','I25.759','I25.760','I25.761','I25.768','I25.769','I25.811','I25.812','M31.11','T86.10','T86.11','T86.12','T86.13','T86.19','T86.20','T86.21','T86.22','T86.23','T86.290','T86.298','T86.30','T86.31','T86.32','T86.33','T86.39','T86.40','T86.41','T86.42','T86.43','T86.49','T86.810','T86.811','T86.812','T86.818','T86.819','T86.8401','T86.8402','T86.8403','T86.8409','T86.8411','T86.8412','T86.8413','T86.8419','T86.8421','T86.8422','T86.8423','T86.8429','T86.8481','T86.8482','T86.8483','T86.8489','T86.8491','T86.8492','T86.8493','T86.8499','T86.850','T86.851','T86.852','T86.858','T86.859','T86.890','T86.891','T86.892','T86.898','T86.899','T86.90','T86.91','T86.92','T86.93','T86.99','Y83.0','Z48.21','Z48.22','Z48.23','Z48.24','Z48.280','Z48.288','Z48.298','Z94.0','Z94.1','Z94.2','Z94.3','Z94.4','Z94.5','Z94.6','Z94.7','Z94.82','Z94.83','Z94.89','Z94.9','Z98.85','429490004','737294004','429054002','13160009','30700006','33167004','44165003','58797008','313039003','62438007','119596005','120158008','183655000','213148006','213152006','233933006','235911006','236570004','236583003','254289008','269295009','312603000','429257001','431505005','441751006','444855007','737295003','737296002','737297006','737298001','737299009','739024006','739025007','739027004','792842004','16058671000119103','16058711000119104','16058831000119102','16058871000119104','233844002','233934000','213151004','432843002','432773004','431896008','431186002','428103008','234520000','234519006','431953002','431862001','432782005','431456004','234522008','58797008','426136000','707148007','213150003','236584009','236572007','236574008','236575009','236576005','236577001','236571000','236573002','236582008','236578006','236579003','236580000','236581001','236587002','236588007','236589004','277010001','236569000','236614007','1144941009','145781000119106','733207001','434270001','433804007','433600001','434238001','233634002','431223003','432774005','432958009','431507002','79369007','431506006','433809002','434271002','433592008','434202008','233979001','234004000','234077006','234008002','234079009','233971003','234066000','262945004','16058751000119103','235912004','213153001','213192008','314760005','433087001','95742008','432265007','16058791000119108','314002005','420505005','421187003','420571002','432908002','432777003','431222008','432772009','236585005','236586006','213086000','213085001','213127009','235910007','1197150002','1230342001','213088004','314551004','314552006','314553001','314554007','737300001','739026008','271976009','213072004','213195005','213126000','281436001','213084002','281437005','213083008','281435002','281438000','213087009','307210003','239185002','239182004','239187005','239183009','403678005','403682007','403681000','403680004','427435004','427889009','428575007','427927008','122511000119103','429450002','429362002','429514007','121131000119109','122491000119108','121121000119106','427928003','129781000119105','122501000119101','762618008','429451003','703048006','713825007','122531000119108','128631000119109','236436003','277011002','445260006','445261005','234001008','773275000','63541000119109','720587009','254290004','445964006','122521000119105','722957003','722956007','722958008','762316003','1156197003','92831004','1153358006','348741000119101','348291000119100','174699007','61535006','70536003','6471000179103','175899003','782655004','313030004','52213001','765478004','765479007','175902000','711411006','711413009','175901007','236138007','71947008','174691005','67562009','345797001','76077004','277451006','174693008','174694002','174692003','18027006','27280000','28009009','174426002','174425003','426356008','174427006','32413006','47058000','32477003','232973007','174802006','174809002','232974001','174808005','405768001','88039007','429332008','62511003','232660006','232658009','232659001','232657004','271581005','39447008','33621000','91243005','22122007','721215004','52384003','77556000','176337003','82316003','56283009','425616008','426463009','439008003','8773000','32956007','67075000','77368008','34538004','120065003','58385009','713157005','34905004','62399001','29931007','359938001','359936002','265506006','3607009','7621005','14377006','19463006','441754003','80070000','71221009','49624000','57363000','7937001','34815006','180000003','88417001','69428003','120050004','119932003','119931005','870382003','120012005','119619005','119846002','9844000','37326001','71890008','55230008','764926003','287239002','426984008','119743004','119757002','18919000','25263003','45669002','85503007','54636000','29507009','17228008','85890008','75479001','27462006','50128001','21030008','90939008','9162006','269701007','270677005','671007','19811006','48772004','3268008','52771009','119906009','359641007','14970003','59654003','264581005','56908006') and dxdate is not null and DATAREFRESHID = 1 )) solid_organ_transplant 
    on eligible_population.patientid = solid_organ_transplant.patientid 
    where dxdate < DATE('2022-02-24')
    group by eligible_population.masterpatientid) 
    where xx = 2
    order by  masterpatientid